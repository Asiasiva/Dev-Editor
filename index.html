<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Live HTML Editor</title>
    
    <!-- 1. Fonts: Poppins (UI) & Fira Code (Code) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- 2. Icons (FontAwesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 3. CodeMirror CSS & Addons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/eclipse.min.css">
    
    <!-- Addon CSS: Folding, Dialog (Search), Hint -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/dialog/dialog.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            /* Light Theme Variables */
            --bg-app: #f8fafc;        /* Slate-50 */
            --bg-sidebar: #ffffff;
            --bg-panel: #ffffff;
            --border-color: #e2e8f0;  /* Slate-200 */
            --text-primary: #334155;  /* Slate-700 */
            --text-secondary: #64748b;/* Slate-500 */
            --accent: #3b82f6;        /* Blue-500 */
            --tab-active: #ffffff;
            --tab-inactive: #f1f5f9;
        }

        body.dark-mode {
            /* Dark Theme Variables (Slate Dark) */
            --bg-app: #0f172a;        /* Slate-900 */
            --bg-sidebar: #1e293b;    /* Slate-800 */
            --bg-panel: #1e293b;      /* Slate-800 */
            --border-color: #334155;  /* Slate-700 */
            --text-primary: #f1f5f9;  /* Slate-100 */
            --text-secondary: #94a3b8;/* Slate-400 */
            --accent: #60a5fa;        /* Blue-400 */
            --tab-active: #1e293b;
            --tab-inactive: #0f172a;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Header & Layout --- */
        .app-header {
            height: 50px;
            background-color: var(--bg-sidebar);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
        }

        .main-workspace {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* --- Sidebar (Snippets) --- */
        .sidebar {
            width: 60px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 1rem;
            gap: 1rem;
            z-index: 10;
        }

        .sidebar-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .sidebar-btn:hover {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--accent);
        }
        /* Tooltip */
        .sidebar-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50px;
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 20;
        }
        .sidebar-btn:hover::after {
            opacity: 1;
        }

        /* --- Editor & Preview Area --- */
        .split-container {
            flex: 1;
            display: flex;
            padding: 0.5rem;
            gap: 0; /* Gap removed for resizer */
            position: relative;
        }
        
        @media (max-width: 768px) {
            .split-container {
                flex-direction: column;
            }
            .sidebar {
                display: none; /* Hide sidebar on mobile for space */
            }
        }

        .panel-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            min-width: 200px; /* Minimum width for resizing */
        }

        /* Resizer Handle */
        .resizer {
            width: 8px;
            background-color: transparent;
            cursor: col-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            z-index: 20;
        }
        .resizer:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .resizer::after {
            content: "";
            width: 2px;
            height: 20px;
            background-color: var(--border-color);
            border-radius: 1px;
        }

        /* Tabs & Controls */
        .panel-header {
            height: 40px;
            background-color: var(--tab-inactive);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center; /* Center items vertically */
            justify-content: space-between; /* Space out items */
            padding: 0 0.5rem;
        }
        
        .tab {
            padding: 0.25rem 0.75rem;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            background-color: transparent;
            border-radius: 6px;
            cursor: default;
            display: flex;
            align-items: center;
        }
        .tab.active {
            color: var(--accent);
            background-color: rgba(59, 130, 246, 0.1);
        }

        /* View Controls */
        .view-controls {
            display: flex;
            gap: 4px;
            background-color: rgba(0,0,0,0.05);
            padding: 2px;
            border-radius: 6px;
        }
        .view-btn {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .view-btn:hover {
            color: var(--text-primary);
        }
        .view-btn.active {
            background-color: var(--bg-panel);
            color: var(--accent);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* --- CodeMirror Customization --- */
        .CodeMirror {
            height: 100%;
            font-family: 'Fira Code', monospace;
            font-size: 13px;
            background-color: var(--bg-panel) !important;
        }
        /* Fix theme background conflict */
        .cm-s-dracula.CodeMirror { background-color: #282a36 !important; }
        .cm-s-eclipse.CodeMirror { background-color: #ffffff !important; }

        /* CodeMirror Hints & Dialogs */
        .CodeMirror-hints {
            z-index: 100;
            font-family: 'Fira Code', monospace;
        }
        
        /* --- Footer --- */
        .status-bar {
            height: 24px;
            background-color: var(--accent);
            color: white;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
        }
        
        /* Iframe Container */
        .preview-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: #e5e5e5;
            overflow: hidden;
        }
        body.dark-mode .preview-wrapper {
            background-color: #0f172a;
        }

        .iframe-container {
            flex: 1;
            display: flex;
            justify-content: center;
            overflow: auto;
            padding: 0;
            transition: height 0.3s;
        }
        
        #output-frame {
            background-color: white;
            transition: width 0.3s ease;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            height: 100%;
        }

        /* --- Console Panel Styles --- */
        #console-panel {
            height: 150px;
            background-color: #1e1e1e;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            font-family: 'Fira Code', monospace;
            font-size: 12px;
            transition: height 0.3s;
        }
        #console-panel.collapsed {
            height: 0;
            overflow: hidden;
            border-top: none;
        }
        
        .console-header {
            background-color: #2d2d2d;
            color: #e0e0e0;
            padding: 4px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        #console-output {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            color: #d4d4d4;
        }
        
        .log-entry {
            border-bottom: 1px solid #333;
            padding: 2px 0;
            display: flex;
        }
        .log-type { margin-right: 8px; font-weight: bold; }
        .log-time { color: #666; margin-right: 8px; font-size: 10px; margin-top: 2px;}
        
        .log-info { color: #60a5fa; }
        .log-warn { color: #facc15; }
        .log-error { color: #f87171; }
        .log-msg { white-space: pre-wrap; word-break: break-all; }

        /* Libraries Modal */
        #lib-modal {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 250px;
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 50;
            padding: 1rem;
            display: none;
        }
        #lib-modal.show { display: block; }
        .lib-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }
        .lib-item:hover { background-color: rgba(0,0,0,0.05); }

    </style>
</head>
<body class="dark-mode">

    <!-- 1. HEADER -->
    <nav class="app-header">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                <i class="fa-solid fa-code"></i>
            </div>
            <span class="font-bold text-lg tracking-tight">DevEditor <span class="text-xs font-normal opacity-70 border border-gray-500 rounded px-1">PRO</span></span>
        </div>

        <div class="flex items-center gap-2">
            <!-- Theme Toggle -->
            <button onclick="toggleTheme()" class="w-8 h-8 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center justify-center transition" title="Toggle Theme">
                <i id="theme-icon" class="fa-solid fa-sun text-yellow-400"></i>
            </button>
            
            <div class="h-4 w-px bg-gray-300 dark:bg-gray-600 mx-1"></div>

            <!-- Library Button -->
            <button onclick="toggleLibModal()" class="text-xs font-medium px-3 py-1.5 rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition flex items-center gap-2" title="Add External Libraries">
                <i class="fa-solid fa-layer-group text-purple-400"></i> Libs
            </button>
            
            <!-- Color Picker -->
            <div class="relative">
                <input type="color" id="color-picker" onchange="insertColor(this.value)" class="absolute opacity-0 w-full h-full cursor-pointer">
                <button class="text-xs font-medium px-3 py-1.5 rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition flex items-center gap-2" title="Pick Color">
                    <i class="fa-solid fa-palette text-pink-400"></i> Color
                </button>
            </div>

            <!-- Delete Button -->
            <button onclick="oneClickDelete()" class="text-xs font-medium px-3 py-1.5 rounded hover:bg-red-100 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 transition flex items-center gap-2" title="Instant Delete">
                <i class="fa-solid fa-trash-can"></i> Clear
            </button>

            <!-- Format Button -->
            <button onclick="formatCode()" class="text-xs font-medium px-3 py-1.5 rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition flex items-center gap-2" title="Format Code">
                <i class="fa-solid fa-wand-magic-sparkles text-yellow-500"></i> Format
            </button>
            
            <button onclick="downloadCode()" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-4 py-1.5 rounded transition shadow-sm" title="Download HTML">
                Download
            </button>
        </div>
    </nav>

    <!-- Libraries Modal -->
    <div id="lib-modal">
        <h3 class="text-sm font-bold mb-2">Add Library</h3>
        <div class="lib-item" onclick="insertLib('bootstrap')">
            <i class="fa-brands fa-bootstrap text-purple-600 mr-2"></i> Bootstrap 5
        </div>
        <div class="lib-item" onclick="insertLib('tailwind')">
            <i class="fa-solid fa-wind text-blue-400 mr-2"></i> Tailwind CSS
        </div>
        <div class="lib-item" onclick="insertLib('jquery')">
            <i class="fa-solid fa-dollar-sign text-blue-600 mr-2"></i> jQuery
        </div>
        <div class="lib-item" onclick="insertLib('fontawesome')">
            <i class="fa-regular fa-flag text-orange-500 mr-2"></i> FontAwesome
        </div>
    </div>

    <!-- 2. WORKSPACE -->
    <div class="main-workspace">
        
        <!-- LEFT SIDEBAR (Snippets) -->
        <aside class="sidebar">
            <div class="sidebar-btn" onclick="insertSnippet('boilerplate')" data-tooltip="HTML5 Boilerplate">
                <i class="fa-brands fa-html5 text-xl"></i>
            </div>
            <div class="sidebar-btn" onclick="insertSnippet('table')" data-tooltip="Insert Table">
                <i class="fa-solid fa-table text-lg"></i>
            </div>
            <div class="sidebar-btn" onclick="insertSnippet('form')" data-tooltip="Insert Form">
                <i class="fa-solid fa-align-justify text-lg"></i>
            </div>
            <div class="sidebar-btn" onclick="insertSnippet('js-test')" data-tooltip="JS Console Test">
                <i class="fa-brands fa-js text-xl text-yellow-400"></i>
            </div>
            <div class="flex-1"></div>
            <div class="sidebar-btn text-red-500 hover:text-red-600" onclick="clearCode()" data-tooltip="Reset All">
                <i class="fa-solid fa-trash"></i>
            </div>
        </aside>

        <!-- MAIN SPLIT VIEW -->
        <main class="split-container" id="split-view">
            
            <!-- EDITOR PANE -->
            <div class="panel-container" id="editor-panel" style="flex: 1;">
                <div class="panel-header">
                    <div class="tab active">
                        <i class="fa-solid fa-file-code mr-2 text-blue-500"></i>index.html
                    </div>
                    <div class="flex items-center gap-2">
                         <span class="text-[10px] text-gray-500 mr-2 hidden md:block">Ctrl+F to Search | Ctrl+Space for Hints</span>
                        <button onclick="copyCode()" class="text-xs text-gray-500 hover:text-blue-500 transition px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fa-regular fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                </div>
                <div class="flex-1 relative">
                    <textarea id="code-editor"></textarea>
                </div>
            </div>

            <!-- RESIZER HANDLE -->
            <div class="resizer" id="resizer"></div>

            <!-- PREVIEW PANE -->
            <div class="panel-container" id="preview-panel" style="flex: 1;">
                <div class="panel-header">
                    <div class="flex items-center gap-2">
                        <div class="tab active">
                            <i class="fa-brands fa-chrome mr-2 text-green-500"></i>Preview
                        </div>
                        <button onclick="toggleConsole()" class="text-xs font-bold px-2 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition ml-2" title="Toggle JS Console">
                            <i class="fa-solid fa-terminal mr-1"></i> Console
                        </button>
                    </div>
                    
                    <div class="view-controls">
                        <div class="view-btn" onclick="setPreviewMode('mobile')" title="Mobile View">
                            <i class="fa-solid fa-mobile-screen"></i>
                        </div>
                        <div class="view-btn" onclick="setPreviewMode('tablet')" title="Tablet View">
                            <i class="fa-solid fa-tablet-screen-button"></i>
                        </div>
                        <div class="view-btn active" onclick="setPreviewMode('desktop')" title="Desktop View">
                            <i class="fa-solid fa-desktop"></i>
                        </div>
                    </div>
                </div>
                
                <div class="preview-wrapper">
                    <!-- Iframe Wrapper -->
                    <div class="iframe-container">
                        <iframe id="output-frame" class="w-full border-none"></iframe>
                    </div>
                    
                    <!-- Console Panel -->
                    <div id="console-panel" class="">
                        <div class="console-header">
                            <span><i class="fa-solid fa-terminal mr-2"></i> JS Console Output</span>
                            <div class="flex gap-2">
                                <button onclick="clearConsole()" class="hover:text-white text-gray-400"><i class="fa-solid fa-ban"></i> Clear</button>
                                <button onclick="toggleConsole()" class="hover:text-white text-gray-400"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                        </div>
                        <div id="console-output">
                            <div class="text-gray-500 italic p-2">Console ready... logs will appear here.</div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- 3. STATUS BAR -->
    <footer class="status-bar">
        <div class="flex gap-4">
            <span><i class="fa-solid fa-code-branch mr-1"></i> main</span>
            <span id="char-count">0 chars</span>
        </div>
        <div>
            <span id="save-status" class="mr-3 opacity-70">Saved</span>
            <span>HTML5 + JS</span>
        </div>
    </footer>

    <!-- SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-html.min.js"></script>

    <!-- CodeMirror Addon Scripts: Folding, Search, Hints -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/xml-fold.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/dialog/dialog.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/search.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/xml-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/html-hint.min.js"></script>

    <script>
        // --- CONFIG ---
        const outputFrame = document.getElementById('output-frame');
        const themeIcon = document.getElementById('theme-icon');
        const charCount = document.getElementById('char-count');
        const saveStatus = document.getElementById('save-status');
        const consoleOutput = document.getElementById('console-output');
        const consolePanel = document.getElementById('console-panel');
        let isDarkMode = true;

        // --- EDITOR INIT ---
        const editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
            mode: "htmlmixed",
            theme: "dracula",
            lineNumbers: true,
            autoCloseTags: true,
            lineWrapping: true,
            indentUnit: 4,
            // 1. Code Folding Enabled
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            // 2. Extra Keys for Autocomplete
            extraKeys: {"Ctrl-Space": "autocomplete"} 
        });

        // --- LIVE PREVIEW & EVENTS ---
        editor.on("change", () => {
            saveStatus.textContent = "Typing...";
            debouncedUpdate();
            updateStats();
        });

        let debounceTimer;
        function debouncedUpdate() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                updateOutput();
                saveCode();
                saveStatus.textContent = "Saved";
            }, 500);
        }

        // --- CONSOLE LOGIC ---
        // We inject this script into the iframe to capture logs
        const consoleInterceptor = `
            <script>
            (function(){
                var oldLog = console.log;
                var oldWarn = console.warn;
                var oldError = console.error;
                var oldInfo = console.info;

                function sendToParent(type, args) {
                    var msg = args.map(arg => {
                        try {
                            return (typeof arg === 'object') ? JSON.stringify(arg) : String(arg);
                        } catch(e) { return String(arg); }
                    }).join(' ');
                    
                    window.parent.postMessage({
                        source: 'iframe-console',
                        type: type,
                        message: msg,
                        time: new Date().toLocaleTimeString()
                    }, '*');
                }

                console.log = function(...args){ oldLog.apply(console, args); sendToParent('info', args); };
                console.warn = function(...args){ oldWarn.apply(console, args); sendToParent('warn', args); };
                console.error = function(...args){ oldError.apply(console, args); sendToParent('error', args); };
                console.info = function(...args){ oldInfo.apply(console, args); sendToParent('info', args); };

                window.onerror = function(msg, url, line) {
                    sendToParent('error', ["Uncaught Error: " + msg + " (Line " + line + ")"]);
                };
            })();
            <\/script>
        `;

        window.addEventListener('message', (event) => {
            if (event.data && event.data.source === 'iframe-console') {
                logToConsoleUI(event.data.type, event.data.message, event.data.time);
            }
        });

        function logToConsoleUI(type, msg, time) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            let colorClass = 'log-info';
            let icon = '<i class="fa-solid fa-info-circle"></i>';
            
            if (type === 'warn') { colorClass = 'log-warn'; icon = '<i class="fa-solid fa-triangle-exclamation"></i>'; }
            if (type === 'error') { colorClass = 'log-error'; icon = '<i class="fa-solid fa-circle-xmark"></i>'; }
            
            entry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-type ${colorClass}">${icon}</span>
                <span class="log-msg ${colorClass}">${msg.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</span>
            `;
            consoleOutput.appendChild(entry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight; 
        }

        function clearConsole() {
            consoleOutput.innerHTML = '<div class="text-gray-500 italic p-2">Console cleared.</div>';
        }

        function toggleConsole() {
            consolePanel.classList.toggle('collapsed');
        }

        function updateOutput() {
            const html = editor.getValue();
            let finalOutput = html;
            if (html.includes('<head>')) {
                finalOutput = html.replace('<head>', '<head>' + consoleInterceptor);
            } else {
                finalOutput = consoleInterceptor + html;
            }
            
            const doc = outputFrame.contentWindow.document;
            doc.open();
            doc.write(finalOutput);
            doc.close();
        }

        function updateStats() {
            const len = editor.getValue().length;
            charCount.textContent = len + " chars";
        }

        // --- NEW FEATURES LOGIC ---

        // 3. Libraries Manager
        function toggleLibModal() {
            document.getElementById('lib-modal').classList.toggle('show');
        }
        function insertLib(type) {
            let tag = '';
            if (type === 'bootstrap') tag = '<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">\n';
            if (type === 'tailwind') tag = '<script src="https://cdn.tailwindcss.com"><\/script>\n';
            if (type === 'jquery') tag = '<script src="https://code.jquery.com/jquery-3.7.0.min.js"><\/script>\n';
            if (type === 'fontawesome') tag = '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">\n';
            
            // Insert into <head> if exists, else top of file
            let content = editor.getValue();
            if (content.includes('</head>')) {
                content = content.replace('</head>', tag + '</head>');
            } else {
                content = tag + content;
            }
            editor.setValue(content);
            toggleLibModal();
        }

        // 4. Color Picker
        function insertColor(hex) {
            editor.replaceSelection(hex);
        }

        // 5. Resizable Split View
        const resizer = document.getElementById('resizer');
        const splitView = document.getElementById('split-view');
        const editorPanel = document.getElementById('editor-panel');
        const previewPanel = document.getElementById('preview-panel');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', () => {
                isResizing = false;
                document.removeEventListener('mousemove', handleMouseMove);
                // Refresh CodeMirror to fix sizing issues
                editor.refresh();
            });
        });

        function handleMouseMove(e) {
            if (!isResizing) return;
            const containerWidth = splitView.offsetWidth;
            const newEditorWidth = (e.clientX / containerWidth) * 100;
            
            // Limit resizing (10% to 90%)
            if (newEditorWidth > 10 && newEditorWidth < 90) {
                editorPanel.style.flex = `0 0 ${newEditorWidth}%`;
                previewPanel.style.flex = `0 0 ${100 - newEditorWidth}%`;
            }
        }

        // --- DEVICE PREVIEW MODE ---
        function setPreviewMode(mode) {
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            if (mode === 'mobile') {
                outputFrame.style.width = "375px";
                event.currentTarget.classList.add('active');
            } else if (mode === 'tablet') {
                outputFrame.style.width = "768px";
                event.currentTarget.classList.add('active');
            } else {
                outputFrame.style.width = "100%";
                event.currentTarget.classList.add('active');
            }
        }

        // --- UTILS ---
        function copyCode() {
            const code = editor.getValue();
            navigator.clipboard.writeText(code).then(() => {
                const btn = document.querySelector('.fa-copy').parentElement;
                btn.innerHTML = '<i class="fa-solid fa-check mr-1"></i> Copied!';
                setTimeout(() => {
                    btn.innerHTML = '<i class="fa-regular fa-copy mr-1"></i> Copy';
                }, 2000);
            });
        }
        
        function oneClickDelete() {
            editor.setValue("");
            updateOutput();
            clearConsole();
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            const body = document.body;

            if (isDarkMode) {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                editor.setOption("theme", "dracula");
                themeIcon.classList.replace('fa-moon', 'fa-sun');
                themeIcon.classList.replace('text-indigo-500', 'text-yellow-400');
            } else {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                editor.setOption("theme", "eclipse");
                themeIcon.classList.replace('fa-sun', 'fa-moon');
                themeIcon.classList.replace('text-yellow-400', 'text-indigo-500');
            }
        }

        function saveCode() {
            localStorage.setItem('proEditor_content', editor.getValue());
        }

        function loadCode() {
            const saved = localStorage.getItem('proEditor_content');
            if (saved) {
                editor.setValue(saved);
            } else {
                insertSnippet('boilerplate'); 
            }
        }

        function formatCode() {
            const rawCode = editor.getValue();
            const formatted = html_beautify(rawCode, {
                indent_size: 4,
                wrap_line_length: 80,
                preserve_newlines: true
            });
            editor.setValue(formatted);
        }

        function insertSnippet(type) {
            let snippet = "";
            if (type === 'boilerplate') {
                snippet = `<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>My Project</title>\n    <style>\n        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #f0f9ff; margin: 0; }\n        .card { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }\n        h1 { color: #0284c7; margin: 0 0 10px 0; }\n        button { padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 5px; cursor: pointer; }\n        button:hover { background: #1d4ed8; }\n    </style>\n</head>\n<body>\n    <div class="card">\n        <h1>ðŸš€ Console Test</h1>\n        <p>Open the Console panel below to see logs!</p>\n        <button onclick="testConsole()">Click Me</button>\n    </div>\n\n    <script>\n        console.log("Welcome to Pro Editor!");\n        \n        function testConsole() {\n            console.log("Button clicked at " + new Date().toLocaleTimeString());\n            console.warn("This is a warning message!");\n        }\n    <\/script>\n</body>\n</html>`;
            } else if (type === 'js-test') {
                snippet = `\n<script>\n  // Test the console\n  console.log("Hello from JavaScript!");\n  console.warn("Warning: Checking variables...");\n  console.error("Error: Something went wrong (Simulation)");\n<\/script>\n`;
            } else if (type === 'table') {
                snippet = `\n<table border="1" style="width:100%; border-collapse:collapse; margin-top:20px;">\n  <tr style="background:#eee;">\n    <th style="padding:8px;">ID</th>\n    <th style="padding:8px;">Name</th>\n  </tr>\n  <tr>\n    <td style="padding:8px;">1</td>\n    <td style="padding:8px;">Alice</td>\n  </tr>\n</table>\n`;
            } else if (type === 'form') {
                snippet = `\n<form style="display:flex; flex-direction:column; gap:10px; max-width:300px;">\n  <label>Name:</label>\n  <input type="text" placeholder="Enter name" style="padding:8px; border:1px solid #ccc; border-radius:4px;">\n  <button style="padding:8px; background:blue; color:white; border:none; border-radius:4px;">Submit</button>\n</form>\n`;
            }

            if (editor.getValue().trim() === "") {
                editor.setValue(snippet);
            } else {
                editor.replaceSelection(snippet);
            }
            formatCode();
        }

        function clearCode() {
            if(confirm("Clear current workspace?")) {
                oneClickDelete();
            }
        }

        function downloadCode() {
            const blob = new Blob([editor.getValue()], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'index.html';
            link.click();
        }

        window.onload = () => {
            loadCode();
            updateOutput();
            updateStats();
        };
    </script>
</body>
</html>
